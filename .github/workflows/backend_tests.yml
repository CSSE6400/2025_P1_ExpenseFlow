name: Backend Tests

on:
  workflow_dispatch:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
    paths:
      - "api/**"

jobs:
  backend_static_type_checking:
    name: Run mypy on backend codebase to do type checking.
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: api
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Install the project
        run: uv sync --locked --all-extras --dev

      - name: Run mypy
        run: uv run mypy .
  backend_tests:
    name: Runs backend tests and generates a coverage report for them.
    runs-on: ubuntu-latest
    needs: backend_static_type_checking
    steps:
      - uses: actions/checkout@v4
      - uses: hoverkraft-tech/compose-action@v2.0.1
        with:
          compose-file: "docker-compose.test.yml"
          up-flags: "--abort-on-container-exit --build"
